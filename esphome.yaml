################################################
#
# DEVICE CONFIGURATION
#
################################################

substitutions:
  name: "power-limiter"
  friendly_name: "Power Limiter"

api:
  encryption:
    key: !secret api_key

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# Web UI comes from Athom package (port 80)

################################################
#
# ATHOM SMART PLUG V3 - BASE
# Source: https://github.com/athom-tech/esp32-configs/blob/main/athom-smart-plug.yaml
#
# NOTE: Using external package during development.
# For production, consider embedding the code directly
# to avoid dependency on external repo changes.
# See git history for embedded version.
#
################################################

packages:
  athom: github://athom-tech/esp32-configs/athom-smart-plug.yaml@main

################################################
#
# CURRENT LIMITER - CUSTOM EXTENSION
# Automatic power cutoff when current exceeds limit
#
################################################

esphome:
  on_boot:
    - priority: 600
      then:
        - if:
            condition:
              switch.is_on: relay
            then:
              - light.turn_on: blue_led
            else:
              - script.execute: led_blink

binary_sensor:
  - platform: template
    name: "Power Off"
    icon: "mdi:alert-circle"
    device_class: problem
    lambda: 'return !id(relay).state;'

### DEBUG START - Remove after calibration ###############
globals:
  - id: peak_current
    type: float
    restore_value: no
    initial_value: '0.0'

interval:
  - interval: 10s
    then:
      - lambda: |-
          ESP_LOGI("cal", "PEAK (10s): %.3fA - resetting", id(peak_current));
          id(peak_current) = 0.0;
### DEBUG END #############################################

sensor:
  - platform: cse7766
    current:
      on_value:
        then:
          - lambda: |-
              ### DEBUG START - Remove after calibration ###
              if (x > id(peak_current)) {
                id(peak_current) = x;
                ESP_LOGI("cal", "NEW PEAK: %.3fA (P=%.1fW)", x, id(power_sensor).state);
              }
              ### DEBUG END ###

              if (id(relay).state && x > id(current_limit).state) {
                ESP_LOGW("limiter", "OVERLOAD: %.2fA > %.1fA - OFF", x, id(current_limit).state);
                id(relay).turn_off();
              }

### DEBUG START - Remove after calibration ###############
  - platform: template
    name: "Peak Current (10s)"
    id: peak_current_sensor
    unit_of_measurement: "A"
    icon: "mdi:chart-line-variant"
    accuracy_decimals: 3
    lambda: 'return id(peak_current);'
    update_interval: 1s
### DEBUG END #############################################

number:
  - platform: template
    name: "Current Limit"
    id: current_limit
    icon: "mdi:current-ac"
    unit_of_measurement: "A"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: 10
    min_value: 0
    max_value: 16
    step: 0.01

switch:
  - platform: gpio
    id: relay
    on_turn_on:
      - script.stop: led_blink
      - light.turn_on: blue_led
    on_turn_off:
      - script.execute: led_blink

script:
  - id: led_blink
    mode: restart
    then:
      - while:
          condition:
            switch.is_off: relay
          then:
            - light.turn_on: blue_led
            - delay: 500ms
            - light.turn_off: blue_led
            - delay: 500ms
